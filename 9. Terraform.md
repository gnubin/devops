
## Terraform

### Отличие ansible и terraform 

- Ответ

    **Terraform** - Предназначен для представления инфраструктуры как код и автоматизации ее развертывания. 
    
    **Ansible** - Предназначен для автоматизации развертывания и конфигурации приложений.
    
    То есть Terraform используется что бы разворачивать инфраструктуру (виртуальные машины, сети, диски, и тп.).
    Ansible предназначен для работы с существующими ресурсами, чтобы устанавливать и настраивать окружение (программы, операционные системы) на этих виртуалках.

    Нюансы:
     Terraform отслеживает состояние и делает инкрементные изменения, что особенно полезно при работе с облачной инфраструктурой.
     Ansible не управляет состоянием, и каждая задача считается независимой.

     Нужно понимать, что это инструменты. И в ряде случаев с помощью Ansible равзвернуть инфраструктуру всё таки можно. 
     Как и для терраформа написать провайдер, который будет делать что-то свое. Вопрос лишь в применимости инструментов. 

---

### Что такое провайдер в terraform

- Ответ

    Это утилита, прослойка, которая позволяет Terraform взаимодействовать с определенным API облачного провадйера.
  
    Провайдеры используются для настройки и управления ресурсами, которые разворачиваются в облаке этого провайдера.

---

### Что такое ресурс в terraform

- Ответ


  Это какой то блок кода, который описывает объект в инфраструктуре. Каждый ресурс имеет свои какие то аргументы, свои параметры, свою конфигурацию. Ресурс имеет свой какой то уникальный идентификатор (ID, ARN и тд).

  Виртуальная машина, сеть, диск, порт, балансировщик и тд.


---

### Что такое tfstate

- Ответ

  Это файл, которй хранит определенное состяние инфраструктуры на момент последнего запуска.
  Используется для отслеживания состояния инфраструктуры терраформом.

---

### configure drift что такое

- Ответ
  
   Это ситуация, когда фактическое состояние инфраструктуры в облаке отличается от ожидаемого состояния, прописанного в terraform файлах.


   Может возникать при изменении ресурсов вне терраформа, либо правки tfstate файла вручную.


   Может привести к удалению ресурсов, либо привести к нежелательным изменениям.

---

### Как блокировать tfstate 

- Ответ 
 
  в AWS облаке tfstate блокируется с помощью dynamoDB.

  При создании DynamoDB в поле Primary key указывается значение LockID типа String.

  В коде это выглядит вот так:

  ```HCL
  
    terraform {
      backend "s3" {
        bucket = "backet_name"
        encrypt = true
        key    = "dev/network/terraform.tfstate"
        region = "us-east-1"
        dynamodb_table = "terraform_state_block_DynamoDB"
    
      }
    }


  ```



  Посмотреть как это делается можно тут -> https://www.youtube.com/watch?v=R9so36Uob8c


---

### Как можно ресурс созданный в GUI перенести в код terraform

- Ответ

  можно использовать terraform import прописав сначала куда импортировать, а затем id ресурса который нужно импортировать

  Пример:

  ```bash

   terraform import aws_instance.instance_to_import  your_resource_id

  ```

  Либо можно в коде прописать секцию import указав id ресурса и куда импортировать
  
  ```HCL

      import {
         id = "your_resource_id"
         to = aws_instance.instance_for_import
       }

  ```

  - После:

  1) terraform plan для того, что бы посмотреть как terraform будет импортировать ресурсы

  2) Потом Apply для того что бы импортировать ресурсы и обновить state file.



  - Можно прописать `terraform plan -generate-config-out=generated.tf` если в конфигурации нету ресурса для импорта и после = написать ваше название файла .tf


  Почитать поподробнее можно здесь -> https://developer.hashicorp.com/terraform/language/import


---

### Отличие contidion от look up

- Ответ

  - lookup это функция которая принимает словарь переменных, который мы пишем обычно в variable.tf файле и ключ значения которое хотим от туда взять

  функция с переменными выглядит как

  **X = lookup(map, key)**

  - Conditions это условия выбора какой либо переменной

  условие с переменными выглядит так

  **X = CONDITION ? IF_TRUE : IF_FALSE**

  Пример как это можно использовать в коде:

  ```HCL

   #condition
   resource "aws_instance" "server" {
     instance_type = var.env == "prod" ? "t3.large" : "t3.micro"
   
   }
   
   #lookup
   variable "ec2_types" {
     default = {
       "prod" = "t3.large"
       "staging" = "t3.medium"
       "dev" = "t3.micro"
     }
   }
   
   resource "aws_instance" "default" {
     instance_type = lookup(var.ec2_types, "prod")
   }

  ```

----

### Ты накидал код в тераформе, запустил план, вышел. После этого твой коллега накидал свой код, выполнил план, вышел. далее тебе нужно зааплаить свою инфру, будут ли какие-то ошибки

- Ответ
  
  Нет, ведь при **terraform plan** файл tfstate не меняется, а только показывается как будет применяться новые изменения к текущей инфраструктуре. 

---

### У вас есть 20 серверов, созданных с помощью Terraform, но вы хотите удалить один из них. Можно ли уничтожить один ресурс из нескольких ресурсов без правки в самих файлах?

- Ответ

  Да можно с помощью команды terraform destroy и флага --target

  ```bash

  terraform destroy -target=aws_instance.my_instance
  
  ```
---

### Какие есть best practice для ухаживания за tfstate file?

- Ответ 

  - Хранить фалй удаленно, например в s3 backet, для обеспечения совместной работы 
    и безопасности.
  - Блокирования состояния на время применения инфраструктуры, для того что бы предотвратить конфликтов между изменениями.
  - Ограничения доступа. Доступ к стейт файлу доступ мог получить только авторизованный пользователь.
  - Настройка автоматических бэкапов, для того что бы не потерять состояние инфры 

---

### У вас есть несколько сред — dev, stage, prod для вашего приложения, и вы хотите использовать один и тот же код для всех этих сред. Как ты можешь это сделать?

- Ответ 

  Есть два вариант как это можно сделать.

  Через модули: 
  
  - Ты пишешь код инфраструктуры, в variable файл выносишь все нужные параметры, что бы их потом можно было заменить, в outputs файл выносишь все нужные выходные данные.

  - Создаешь рядом с папкой с модулем создаешь уже папку проекта с папками под каждое окружение. 
    В них уже создаешь условно файлик main.tf и в нем прописываешь блок кода module, и в коде проекта в среде прод этот блок кода может выглядить как:

    ```HCL
    
        module "vpc_prod" {
            source     = "../../modules/vpc_and_network"
            env        = "production"                                                
            cidr_block = "10.100.1.0/24"  
          
            publick_cidr_subntet = [
              "10.100.12.0/24",
              "10.100.13.0/24",
              "10.100.14.0/24",
            ]
            private_cidr_subnets = [
              "10.100.21.0/24",
              "10.100.22.0/24"
            ]
        }
       #так же это могут быть модули, которые хранятся удаленно
    
    ```
    
  Структура папок может выглядить вот так:

  ![not_best](not_best_practice.png)

  Env по папкам это часто используется, но на деле это противоречит DRY. 
  Тут в качестве бест практис лучше иметь конфиги террагрунта под каждый env со своими переменными под окружени.
  
  Структура папок по бестпрактис может выглядить вот так:

  ![better](folder_struct_best_practice.png)



  - Есть метод через workspace который почти нигде не используется.

  - Так же в качестве best practice разграничение по аккам используется, с точки зрения тф нужно будет деплоиться на разных акках

   В коде это будет выглядить как: 

  ```HCL

      provider "aws" {
          region = "eu-central-2"
        
        
          assume_role {
            role_arn     = "arn:aws:iam::1234567890:role/RemoteAdministrator"
            session_name = "terraform session"                                
    
      }

  ```

  На аккаунте на котором будет происходить деплой должна быть соответсвующая роль которая позволяет это делать, либо нужно вводить access_key и secret_key


---

