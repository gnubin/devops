***
В качестве одного из самых популярных балансировщиков (наряду с NGINX) разберем основы по работе с HAProxy.

**HAProxy** - это бесплатное и открытое программное обеспечение, которое предоставляет высокодоступный балансировщик нагрузки и прокси для TCP и HTTP-базированных приложений, распределяющий запросы между несколькими серверами.

Базовая конфигурация HAProxy расположена в **`/etc/haproxy/haproxy.cfg`**
### **Основные задачи**
  
1. **Распределение нагрузки** - равномерное распределение запросов между серверами.  
2. **Отказоустойчивость** - автоматическое исключение нерабочих серверов из ротации.  
3. **Масштабируемость** – возможность добавлять/удалять серверы без downtime.
### **Типы балансировки**

![](https://img3.teletype.in/files/25/c0/25c0701f-c534-4a99-af06-5d27186092f6.png)

### **Алгоритмы балансировки трафика**

1. **Round Robin:** Это один из самых простых алгоритмов, при котором запросы последовательно и равномерно распределяются между идентичными серверами. Каждый новый запрос направляется к следующему серверу в списке, и так по кругу
2. **Least Connections:** Запросы идут на сервер с наименьшим количеством активных соединений. Этот алгоритм учитывает текущую нагрузку на сервера и стремится равномерно распределить нагрузку
3. **Source:** Алгоритм использует хэш-функцию от IP-адреса клиента для определения сервера, к которому будет направлен запрос. Это обеспечивает, что запросы от одного и того же источника будут направляться к одному и тому же серверу (пока набор серверов не изменится)
4. **URI:** Алгоритм использует хэш от URI запроса для определения сервера, что позволяет сохранить сессионную стабильность для динамических запросов, связанных с определенными URL. Запросы с одинаковым URI всегда идут на один сервер
5. **Header:** Алгоритм использует хэш от значений определенных заголовков HTTP-запроса для распределения трафика, что может быть полезно для балансировки на основе конкретных данных запроса
6. **Random:** Выбирает случайный сервер для каждого запроса
7. **Static-RR:** Подобно Round Robin, но с возможностью устанавливать веса для серверов, что позволяет контролировать пропорциональное распределение нагрузки между серверами, если сервера не идентичны по мощности.

### Основные секции конфига  

Базовая конфигурация HAProxy расположена в **`/etc/haproxy/haproxy.cfg

- **Глобальные настройки (global):** Здесь определяются параметры, применимые ко всему процессу HAProxy, такие как логирование, настройки производительности и безопасности.
- **Настройки по умолчанию (defaults):** Эти настройки по умолчанию применяются к фронтендам и бэкендам, если для них не заданы индивидуальные параметры. Сюда могут входить настройки таймаутов, опции мониторинга и методы балансировки нагрузки.
- **Фронтенды (frontend):** Фронтенды определяют точки входа для входящего трафика, где вы можете настроить порты прослушивания, ACL (списки контроля доступа) и правила маршрутизации трафика. Занимается обработкой входящих запросов.
- **Бэкенды (backend):** Бэкенды содержат конфигурации групп серверов, куда HAProxy будет перенаправлять трафик. Здесь вы указываете серверы, их IP-адреса и порты, а также настраиваете алгоритмы балансировки нагрузки и проверки работоспособности серверов. Проще говоря, здесь блок - куда перенаправляются запросы.
- **Слушатели (listen):** Комбинированные секции, которые объединяют функции фронтенда и бэкенда в одной конфигурации. Они полезны для упрощения конфигурации при одновременной настройке прослушивания портов и серверов.

### **Health Checks (проверки работоспособности)**

HAProxy периодически проверяет, доступны ли серверы.

Пример проверки:

backend http_back
    server web1 192.168.1.10:80 check inter 2s fall 3 rise 2

- `inter 2s` – интервал проверки (2 секунды).
- `fall 3` – сервер считается "упавшим" после 3 неудачных проверок.
- `rise 2` – сервер возвращается в строй после 2 успешных проверок.

Пример конфига:
```bash
global
 log 127.0.0.1 local2 # Настройка куда писать логи
 maxconn 4000 # Максимальное количество одновременных соединений
 user  haproxy # Пользователь, от имени которого будет работать процесс
 group haproxy # Группа, от имени которой будет работать процесс
 daemon  # Запуск HAProxy в фоновом режиме (демоном)
 
defaults
 mode http # Режим работы (http или tcp)
 log global # Использовать настройки логгирования из global
 option httplog # Включить расширенное логгирование HTTP-запросов
 option dontlognull # Не логировать соединения без данных
 option http-server-close  # Закрывать соединение на стороне сервера после ответа
 option forwardfor except 127.0.0.1   # Добавлять заголовок X-Forwarded-For, кроме запросов с 127.0.0.1
 option  redispatch  # Повторно отправлять запрос на другой сервер, если первый не ответил
 retries 3  # Количество попыток повторной отправки запроса при ошибке
 # Таймауты:
 timeout http-request 10s    # Макс. время ожидания полного HTTP-запроса
 timeout queue 1m           # Макс. время ожидания в очереди
 timeout connect 10s        # Макс. время установки соединения с бэкендом
 timeout client 1m          # Макс. время бездействия клиента
 timeout server 1m          # Макс. время бездействия сервера
 timeout check 10s          # Таймаут для health check
 stats enable    # Включение статистики
 stats uri /haproxy_stats # URL для доступа к статистике

frontend main # Фронтенд - настройки для входящих соединений
 bind *:80  # Слушать на всех IP-адресах, порт 80
 acl url_static path_beg -i /static /images /javascript /stylesheets # ACL для статического контента: проверка начала URL
 acl url_static path_end -i .jpg .gif .png .css .js  # ACL для статического контента: проверка окончания URL
 use_backend static_servers if url_static  default_backend app_servers  # Использовать бэкенд static_servers если сработал ACL url_static,
    # в противном случае использовать app_servers

backend static_servers # Бэкенд для статического контента
 balance roundrobin  # Алгоритм балансировки - round-robin
 server static1 192.0.2.1:80 check # Серверы приложения с проверкой доступности (check) 
 server static2 192.0.2.2:80 check # Серверы приложения с проверкой доступности (check)

backend app_servers
 balance leastconn  # Алгоритм балансировки - leastconn
 server app1 192.0.2.10:8080 check   
 server app2 192.0.2.11:8080 check
```

### Дополнительные важные функции

**Ограничение доступа по IP:**

acl allowed_ips src 192.168.1.100 10.0.0.0/24 # Указывает access list и список IP
http-request deny if !allowed_ips # Директива по отклонению IP, не входящих в список выше

**Rate Limiting (ограничение запросов):**

stick-table type ip size 100k expire 30s store http_req_rate(10s)
http-request track-sc0 src
http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

(Блокирует IP, если >100 запросов за 10 секунд)

- `stick-table` – хранилище для отслеживания клиентов.
- `http-request track-sc0 src` – запоминать IP-адреса.
- `deny_status 429` – возвращать код `429 Too Many Requests`.

***
#devops #HAProxy